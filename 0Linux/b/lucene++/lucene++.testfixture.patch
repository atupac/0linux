From 4c1f1371e98c387cb07043c26b99beff5b5111a8 Mon Sep 17 00:00:00 2001
From: Alan Wright <alan@spotify.com>
Date: Mon, 28 Apr 2014 13:53:48 +0100
Subject: [PATCH] Throw exception in fixture destructor instead of FAIL().
====
From 474d308600aecabfa88c27e691fa13e815e4649f Mon Sep 17 00:00:00 2001
From: Gianfranco Costamagna <costamagnagianfranco@yahoo.it>
Date: Wed, 2 Jul 2014 17:23:27 +0200
Subject: [PATCH] Update LuceneTestFixture.cpp
====
From e349e74f59d4358dad899cdbc355edd6734b51f1 Mon Sep 17 00:00:00 2001
From: Gianfranco Costamagna <costamagnagianfranco@yahoo.it>
Date: Wed, 2 Jul 2014 17:25:37 +0200
Subject: [PATCH] Update LuceneTestFixture.h

---
 src/test/util/LuceneTestFixture.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/test/util/LuceneTestFixture.cpp b/src/test/util/LuceneTestFixture.cpp
index 27c61e0..e737bdb 100644
@@ -17,10 +17,14 @@ LuceneTestFixture::LuceneTestFixture() {
 }
 
 LuceneTestFixture::~LuceneTestFixture() {
+    // Moved out to a separate function since GTEST_FAIL cannot be used in destructors
+    destructorBody();
+}
+void LuceneTestFixture::destructorBody() {
     DateTools::setDateOrder(DateTools::DATEORDER_LOCALE);
     if (ConcurrentMergeScheduler::anyUnhandledExceptions()) {
         // Clear the failure so that we don't just keep failing subsequent test cases
         ConcurrentMergeScheduler::clearUnhandledExceptions();
-        FAIL() << "ConcurrentMergeScheduler hit unhandled exceptions";
+        boost::throw_exception(RuntimeException(L"ConcurrentMergeScheduler hit unhandled exceptions"));
     }
 }
diff --git a/src/test/include/LuceneTestFixture.h b/src/test/include/LuceneTestFixture.h
index fd7371a..5613658 100644
--- a/src/test/include/LuceneTestFixture.h
+++ b/src/test/include/LuceneTestFixture.h
@@ -13,6 +13,7 @@ class LuceneTestFixture : public testing::Test {
     /// setup
     LuceneTestFixture();
 
+    void destructorBody();
     /// teardown
     virtual ~LuceneTestFixture();
 };
